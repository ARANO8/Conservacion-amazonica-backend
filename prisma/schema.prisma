generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Role {
  id    Int    @id @default(autoincrement())
  name  String @unique
  users User[]
}

model User {
  id               String           @id @default(uuid())
  email            String           @unique
  password         String
  fullName         String
  position         String?
  area             String?
  isActive         Boolean          @default(true)
  supervisorId     String?
  roleId           Int
  createdAt        DateTime         @default(now())
  updatedAt        DateTime         @updatedAt
  approvedRequests Request[]        @relation("Approver")
  requests         Request[]        @relation("Requester")
  refRequests          Request[]        @relation("RefUser")
  disbursementRequests Request[]        @relation("DisbursementUser")
  approvals        RequestHistory[]
  role             Role             @relation(fields: [roleId], references: [id])
  supervisor       User?            @relation("Hierarchy", fields: [supervisorId], references: [id])
  subordinates     User[]           @relation("Hierarchy")
}

model FinancingSource {
  id           String        @id @default(uuid())
  code         String        @unique
  name         String
  budgets      Budget[]
  requestItems RequestItem[]
}

model BudgetLine {
  id           String        @id @default(uuid())
  code         String        @unique
  name         String
  category     String?
  budgets      Budget[]
  requestItems RequestItem[]
}

model Activity {
  id        String       @id @default(uuid())
  code      String
  name      String
  type      ActivityType
  parentId  String?
  createdAt DateTime     @default(now())
  updatedAt DateTime     @updatedAt
  parent    Activity?    @relation("ActivityHierarchy", fields: [parentId], references: [id])
  children  Activity[]   @relation("ActivityHierarchy")
  budgets   Budget[]
}

model PoaActivity {
  id            String   @id @default(uuid())
  code          String   // El "Código Control"
  
  // Jerarquía Estratégica
  og            String?
  oe            String?
  op            String?
  ac            String?
  
  // Clasificación
  project       String   // Nombre del Proyecto (ej: "RAINFOREST")
  group         String?  // Grupo de Gasto
  poaBudgetLine String?  // La Partida del POA
  
  // Detalle
  activityCode  String?  // Código interno de sistema
  description   String   @db.Text
  
  // Financiero
  unitCost      Float?
  totalCost     Float?
  
  // Relaciones
  requests      Request[]
  
  // Timestamps
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
}

model Budget {
  id                String          @id @default(uuid())
  amountAssigned    Decimal         @db.Decimal(15, 2)
  amountExecuted    Decimal         @default(0) @db.Decimal(15, 2)
  amountCompromised Decimal         @default(0) @db.Decimal(15, 2)
  activityId        String
  sourceId          String
  budgetLineId      String
  activity          Activity        @relation(fields: [activityId], references: [id])
  budgetLine        BudgetLine      @relation(fields: [budgetLineId], references: [id])
  financingSource   FinancingSource @relation(fields: [sourceId], references: [id])

  @@unique([activityId, sourceId, budgetLineId])
}

model Request {
  id             String           @id @default(uuid())
  code           String           @unique
  status         RequestStatus    @default(DRAFT)
  totalAmount    Decimal          @db.Decimal(15, 2)
  requesterId    String
  createdAt      DateTime         @default(now())
  updatedAt      DateTime         @updatedAt
  approverId     String?
  description    String
  title          String
  endDate        DateTime?
  place          String?
  poaCode        String?
  receiverName   String?
  startDate      DateTime?
  poaActivityId  String?
  refById        String?
  disbursementToId String?
  
  poaActivity    PoaActivity?     @relation(fields: [poaActivityId], references: [id])
  refBy          User?            @relation("RefUser", fields: [refById], references: [id])
  disbursementTo User?            @relation("DisbursementUser", fields: [disbursementToId], references: [id])
  
  quotes         Quote[]
  rendition      Rendition?
  approver       User?            @relation("Approver", fields: [approverId], references: [id])
  requester      User             @relation("Requester", fields: [requesterId], references: [id])
  history        RequestHistory[]
  items          RequestItem[]
  travelExpenses TravelExpense[]
}

model RequestItem {
  id                String          @id @default(uuid())
  description       String
  requestId         String
  budgetLineId      String
  financingSourceId String
  detail            String?
  documentNumber    String?
  quantity          Int             @default(1)
  totalAmount       Decimal         @default(0) @db.Decimal(15, 2)
  unitCost          Decimal         @default(0) @db.Decimal(15, 2)
  budgetLine        BudgetLine      @relation(fields: [budgetLineId], references: [id])
  financingSource   FinancingSource @relation(fields: [financingSourceId], references: [id])
  request           Request         @relation(fields: [requestId], references: [id])
}

model TravelExpense {
  id            String  @id @default(uuid())
  concept       String
  city          String?
  destination   String?
  transportType String?
  days          Int?
  peopleCount   Int?
  requestId     String
  request       Request @relation(fields: [requestId], references: [id])
}

model Quote {
  id           String  @id @default(uuid())
  supplierName String
  amount       Decimal @db.Decimal(15, 2)
  isSelected   Boolean @default(false)
  fileUrl      String?
  requestId    String
  request      Request @relation(fields: [requestId], references: [id])
}

model RequestHistory {
  id          String        @id @default(uuid())
  status      RequestStatus
  observation String?
  date        DateTime      @default(now())
  requestId   String
  actorId     String
  actor       User          @relation(fields: [actorId], references: [id])
  request     Request       @relation(fields: [requestId], references: [id])
}

model Rendition {
  id            String    @id @default(uuid())
  code          String    @unique
  renditionDate DateTime  @default(now())
  totalExpenses Decimal   @db.Decimal(15, 2)
  balance       Decimal   @db.Decimal(15, 2)
  requestId     String    @unique
  expenses      Expense[]
  request       Request   @relation(fields: [requestId], references: [id])
}

model Expense {
  id            String      @id @default(uuid())
  date          DateTime
  invoiceNumber String?
  description   String
  amount        Decimal     @db.Decimal(15, 2)
  type          ExpenseType @default(INVOICE)
  taxRcIva      Decimal     @default(0) @db.Decimal(10, 2)
  taxIue        Decimal     @default(0) @db.Decimal(10, 2)
  taxIt         Decimal     @default(0) @db.Decimal(10, 2)
  totalDeclared Decimal     @db.Decimal(15, 2)
  renditionId   String
  receiptUrl    String?
  rendition     Rendition   @relation(fields: [renditionId], references: [id])
}

enum ActivityType {
  OG
  OE
  OP
  AC
}

enum RequestStatus {
  DRAFT
  REVIEW_SUPERVISOR
  REVIEW_DIRECTOR
  REVIEW_FINANCE
  APPROVED
  REJECTED
  DISBURSED
  COMPLETED
}

enum ExpenseType {
  INVOICE
  RETENTION_GOODS
  RETENTION_SERVICES
  NO_DEDUCTIBLE
}

enum Currency {
  BS
  USD
}
